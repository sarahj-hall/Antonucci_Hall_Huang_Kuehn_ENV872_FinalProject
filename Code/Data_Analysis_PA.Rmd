---
title: "Data_Analysis_PA"
author: "Addisen Antonucci"
date: "2025-12-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##  Setting Up
```{r}
#load packages
library(tidyverse)
library(lubridate)
library(trend)
library(zoo)
library(Kendall)
library(tseries)
library(here)

#read in processed PA data
outage_group_PA <- read.csv(here('Data/Processed/outage_group_PA.csv'), 
                    stringsAsFactors = TRUE)
#Set Theme
mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")
theme_set(mytheme)

#Format Date  
outage_group_PA$date <- ymd(outage_group_PA$date)

```

##  How have outage frequencies changed over time?
###  Initial Plots
```{r}
#Outages by Month
monthly_outages_PA <- outage_group_PA %>%
  mutate(
    year = year(date),
    month = month(date),
    year_month = as.Date(paste(year, month, "01", sep = "-"))
  ) %>%
  group_by(year_month) %>%
  summarise(outage_count = sum(outage_count))

#Initial observations of Outages
ggplot(monthly_outages_PA, aes(x = year_month, y = outage_count)) +
  geom_line() +
  labs(x = "Year", y = "Outage Count") +
  geom_smooth(method = "lm", color = "#c13d75ff")

```

### Time Series of outage_count
```{r}
#Creating time Series Objects
Outages_ts_PA <- ts(monthly_outages_PA$outage_count, start = c(2015,1), end =c(2023,12), frequency = 12)

#Visualize Decomposed Series
Outage_Decomposed_PA <- stl(Outages_ts_PA, s.window = "periodic")

plot(Outage_Decomposed_PA)

##Is there Seaonality?
#Extracting components into Data Frame
Outage_components_PA<-as.data.frame(Outage_Decomposed_PA$time.series[,1:3])

Outage_components_PA <- mutate(Outage_components_PA,
        Observed = monthly_outages_PA$outage_count,     
        Date = monthly_outages_PA$year_month)

#Visualize the trends
ggplot(Outage_components_PA)+
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  xlab("Date")
  ylab("Outages")
  
#Visualize seasonal Component 
ggplot(Outage_components_PA) +
  geom_line(aes(x = Date, y = seasonal), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  labs(y = "Seasonal Component", x = "Date")

Outage_components_PA$Month <- month(Outage_components_PA$Date)


#seasonal by month
ggplot(Outage_components_PA) +
  geom_line(aes(
    x = factor(Month, levels = 1:12, labels = month.abb),
    y = seasonal,
    group = year(Date)
  ), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Month", y = "Seasonal Component",
       title = "Seasonal Cycle of Outages in Pennsylvania")

#Mann-Kendall Seasonality Test
Ouatges_PA_SMK <- Kendall::SeasonalMannKendall(Outages_ts_PA)
Ouatges_PA_SMK
summary(Ouatges_PA_SMK)
#p-value is 0.009

#Remove Seasonal
PA_outage_non_seas <- Outages_ts_PA - Outage_components_PA$seasonal

PA_outage_MK_noseason <- trend::mk.test(PA_outage_non_seas)
PA_outage_MK_noseason
#p-value is 0.002
```

##Time Series Analysis for customer_weighted_hours
```{r}
# Aggregate monthly
monthly_cwh_PA <- outage_group_PA %>%
  mutate(
    year = year(date),
    month = month(date),
    year_month = as.Date(paste(year, month, "01", sep = "-"))
  ) %>%
  group_by(year_month) %>%
  summarise(customer_weighted_hours = sum(customer_weighted_hours, na.rm = TRUE),
            .groups = "drop")

#Initla Obseravtions of customer-weighted hours
ggplot(monthly_cwh_PA, aes(x = year_month, y = customer_weighted_hours)) +
  geom_line() +
  labs(x = "Year", y = "Customer Weighted Hours",
       title = "Monthly Customer-Weighted Hours (PA)") +
  geom_smooth(method = "lm", color = "#c13d75ff")

# Create time series object
CWH_ts_PA <- ts(
  monthly_cwh_PA$customer_weighted_hours,
  start = c(year(min(monthly_cwh_PA$year_month)),
            month(min(monthly_cwh_PA$year_month))),
  frequency = 12
)

# Visualize Decomposed series
CWH_decompose_PA <- stl(CWH_ts_PA, s.window = "periodic")
plot(CWH_decompose_PA)

##Is there Seaonality?
#Extracting components into Data Frame
CWH_components_PA <- as.data.frame(CWH_decompose_PA$time.series[,1:3]) %>%
  mutate(
    Observed = monthly_cwh_PA$customer_weighted_hours,
    Date = monthly_cwh_PA$year_month,
    Month = month(Date)
  )

#Visualize the trends
ggplot(CWH_components_PA) +
  geom_line(aes(x = Date, y = Observed), size = 0.3) +
  geom_line(aes(x = Date, y = trend), color = "#c13d75ff", linewidth = 0.8) +
  labs(x = "Date", y = "Customer Weighted Hours",
       title = "Observed vs Trend in Customer-Weighted Hours (PA)") +
  geom_hline(yintercept = 0, linetype = "dashed")

#seasonal by month
ggplot(CWH_components_PA) +
  geom_line(aes(x = Date, y = seasonal), color = "#c13d75ff") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Date", y = "Seasonal Component",
       title = "Seasonality of Customer-Weighted Hours (PA)")

# Seasonal Cycle by Month
ggplot(CWH_components_PA) +
  geom_line(aes(
    x = factor(Month, levels = 1:12, labels = month.abb),
    y = seasonal,
    group = year(Date)
  ), color = "#c13d75ff") +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = "Month", y = "Seasonal Component",
       title = "Seasonal Cycle of Customer-Weighted Hours (PA)")

#Mann-Kendall Seasonality Test
CWH_MK_PA <- trend::smk.test(CWH_ts_PA)
CWH_MK_PA
summary(CWH_MK_PA)

#Remove Seasonal
CWH_non_seas_PA <- CWH_ts_PA - CWH_components_PA$seasonal
CWH_MK_noseason_PA <- trend::mk.test(CWH_non_seas_PA)
CWH_MK_noseason_PA

```

