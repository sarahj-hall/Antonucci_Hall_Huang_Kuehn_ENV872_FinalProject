---
title: "Time Series Analysis for FL"
author: "Isabelle Kuehn"
date: "2025-12-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# From Intitial Data Exploration
library(here)
library(tidyverse)
library(viridis)
library(RColorBrewer)
library(colormap)

outage_group_2021 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2021_group.csv'),
                              stringsAsFactors = TRUE)
outage_merged_2021 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2021_merged.csv'),
                              stringsAsFactors = TRUE)
outage_events_2021_24hr <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_with_events_2021_24_hours_lag.csv'), stringsAsFactors = TRUE)

outage_group_2015 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2015_group.csv'), stringsAsFactors = TRUE)
outage_group_2016 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2016_group.csv'), stringsAsFactors = TRUE)
outage_group_2017 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2017_group.csv'), stringsAsFactors = TRUE)
outage_group_2018 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2018_group.csv'), stringsAsFactors = TRUE)
outage_group_2019 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2019_group.csv'), stringsAsFactors = TRUE)
outage_group_2020 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2020_group.csv'), stringsAsFactors = TRUE)
outage_group_2021 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2021_group.csv'), stringsAsFactors = TRUE)
outage_group_2022 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2022_group.csv'), stringsAsFactors = TRUE)
outage_group_2023 <- read.csv(here('Data/Raw/Outage_Dataset/eaglei_outages_2023_group.csv'), stringsAsFactors = TRUE)

#merge into one dataset
outage_group_all_years <- rbind(outage_group_2015, outage_group_2016,outage_group_2017, outage_group_2018, outage_group_2019, outage_group_2020, outage_group_2021, outage_group_2022, outage_group_2023)

#change columns to state abbrevations
outage_group_all_years$state <- state.abb[match(outage_group_all_years$state, state.name)]

#export to combined years dataset
write.csv(outage_group_all_years, row.names = FALSE, 
          file = "./Data/Processed/outage_group_all_years.csv")

#filter out for FL 
outage_group_FL <- outage_group_all_years %>% 
  filter(state == 'FL') 
```

```{r}
my_theme <- theme_classic + theme(axis.text.x = element_text(angle = 45))

summary(outage_events_2021_24hr)
summary(outage_group_2021)
summary(outage_merged_2021)

#boxplot for total yearly outages from 2015-2023
outage_group_all_years %>% 
  filter(month == 0) %>% 
  ggplot(aes(x = state,
      y = outage_count))+
  geom_boxplot()

outage_group_FL %>% 
  filter(month == 0) %>% 
  ggplot(aes(x = year,
      y = outage_count))+
  geom_point()+
  geom_line()

#plots for Florida, monthly 
outage_group_FL %>% 
  filter(month != 0) %>% 
  ggplot(
    mapping = aes(
      x=factor(
      month,
      levels=1:12,
      labels=month.abb),
      y = outage_count,
      color = year)
    ) +
 geom_point(size = 2, alpha = 0.7)+
 scale_color_viridis(
   option = "mako", 
   direction = -1)+
  labs(
    title = "Number of Power Outages in Florida by Month from 2015 to 2023",
    y = "Number of Outages",
    x = "Month",
    color = "Year",
  )
```

```{r}
# Data Wrangling

# Create data sets like the plots above that distinguish between yearly outages in FL and monthly averages in FL

yearly_outages_FL <- outage_group_FL %>%
  filter(month == 0)

monthly_outages_FL <- outage_group_FL %>%
  filter(month != 0)
```

```{r}
yearly_outages_FL_plot <- ggplot(yearly_outages_FL, aes(x = year, y = outage_count)) +
  geom_line() + 
  geom_point() +
  geom_smooth(method="lm", se = FALSE, color = "darkorchid4") +
  labs(title = "2015-2023 Yearly Outages for Florida",
       y="Outage Count",
       x="Year")

yearly_outages_FL_plot
```

```{r}
# Monthly Outages Across FL from 2015-2023 with Linear Regression
monthly_outages_FL <- monthly_outages_FL %>% 
  mutate(Date = my(paste(month,"-",year)))

monthly_outages_FL_plot <- ggplot(monthly_outages_FL, 
                                  aes(x=factor(month, levels = 1:12, labels = month.abb), 
                                      y=outage_count, color = factor(year))) + 
  geom_point(size = 2, alpha = 0.7) +
  scale_colour_viridis(option = "mako", direction = -1, discrete = TRUE) +
  labs(title = "2015-2023 Monthly Outages for Florida",
       y="Outage Count",
       x="Date",
       color = "Year")

monthly_outages_FL_plot
```


## Time Series Analysis

Main question: How have outage occurrences changed in Florida from 2015 to 2023? Have the duration of those outages changed? Are outages occurrences or longer durations consistent with any extreme weather events in FL? Do any of the results reflect seasonality?

```{r}
# Time Series Analysis for FL Outage Count
first_month <- first(monthly_outages_FL$month)
first_year <- first(yearly_outages_FL$year)

monthly_outages_FL.ts <- ts(monthly_outages_FL$outage_count, 
                             frequency = 12, start = c(first_year, first_month))

# Plot each time series
FL_monthly_decomposed <- stl(monthly_outages_FL.ts, s.window = "periodic")
plot(FL_monthly_decomposed, main = "Time Series Analysis for Monthly FL Outages")

FL_monthly_outage_trend <- trend::smk.test(monthly_outages_FL.ts)
FL_monthly_outage_trend
```

```{r}
# Monthly Outage TS Decomposition

monthly_outages_FL.components <- as.data.frame(FL_monthly_decomposed$time.series[,1:3])

monthly_outages_FL.components <- mutate(monthly_outages_FL.components,
        Observed = monthly_outages_FL$outage_count,     
        Date = monthly_outages_FL$Date)

# Trend Plot
ggplot(monthly_outages_FL.components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.5) +
  geom_line(aes(y = trend, x = Date), color = "slateblue") +
  ylab("Outage Count")
  
# Seasonality Plot
ggplot(monthly_outages_FL.components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.5) +
  geom_line(aes(y = seasonal, x = Date), color = "slateblue") +
  ylab("Outage Count")
```


What does this show?
Seasonal Mann Kendall tests are run to show statistical evidence for seasonality across datasets. The results of the Mann Kendall test show a p-value well below 0.05, providing significant statistical support in proving seasonal trends across Florida from 2015-2023.

```{r}
# Time Series Analysis for FL Customer Weighted Hours
# customer weighted hours = customer hours x duration

monthly_wHrs_FL.ts <- ts(monthly_outages_FL$customer_weighted_hours, 
                             frequency = 12, start = c(first_year, first_month))

# Plot each time series
FL_wHrs_decomposed <- stl(monthly_wHrs_FL.ts, s.window = "periodic")
plot(FL_wHrs_decomposed, main = "Time Series Analysis for Monthly FL Customer Weighted Hours")

```

```{r}
# Monthly Customer Weighted Hours TS Decomposition

monthly_wHrs_FL.components <- as.data.frame(FL_wHrs_decomposed$time.series[,1:3])

monthly_wHrs_FL.components <- mutate(monthly_wHrs_FL.components,
        Observed = monthly_outages_FL$customer_weighted_hours,     
        Date = monthly_outages_FL$Date)

# Trend Plot
ggplot(monthly_wHrs_FL.components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.5) +
  geom_line(aes(y = trend, x = Date), color = "darkseagreen4") +
  ylab("Customer Weighted Duration")
  
# Seasonality Plot
ggplot(monthly_wHrs_FL.components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.5) +
  geom_line(aes(y = seasonal, x = Date), color = "darkseagreen4") +
  ylab("Customer Weighted Duration")
```

For the customer weighted hours, Mann Kendall test also shows statistical evidence for seasonality. Graphs of the TS decomposition show large spikes just before 2018 (likely from increase in data collection).
